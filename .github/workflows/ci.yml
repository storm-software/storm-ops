name: "CI/CD"

on:
  workflow_dispatch:
    inputs:
      tag:
        description: override release tag
        required: false
  push:
    branches:
      - "main"
      - "next"
      - "alpha"
      - "beta"

env:
  CI: true
  NX_DAEMON: false
  NX_VERBOSE_LOGGING: true
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
  NX_CLOUD_AUTH_TOKEN: ${{ secrets.NX_CLOUD_AUTH_TOKEN }}
  NX_BASE: ${{ github.base_ref }}
  NX_HEAD: ${{ github.head_ref }}
  GITHUB_ACTOR: ${{ github.actor }}
  GITHUB_TOKEN: ${{ github.token }}
  GH_TOKEN: ${{ github.token }}
  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
  DEV_REPO_ROOT: ${{ github.workspace }}
  NX_WORKSPACE_ROOT_PATH: ${{ github.workspace }}

jobs:
  build-and-release:
    if: github.repository == 'storm-software/storm-ops' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/next' || github.ref == 'refs/heads/alpha' || github.ref == 'refs/heads/beta')
    name: "Build & Release"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup workspace
        uses: ./.github/actions/setup-workspace

      - name: configure git
        run: |
          git config user.name "${{ env.CI_REPO_OWNER }}"
          git config user.email "${{ env.CI_REPO_OWNER }}@users.noreply.github.com"
          npm config set '//registry.npmjs.org/:_authToken' "${NPM_TOKEN}"

      - name: Install dependencies
        run: pnpm install

      - name: Get appropriate base and head commits for `nx affected` commands
        uses: nrwl/nx-set-shas@v4
        with:
          main-branch-name: "main"

      - name: Set appropriate base and head commits for `nx affected` commands
        run: |
          echo "BASE: ${{ env.NX_BASE }}"
          echo "HEAD: ${{ env.NX_HEAD }}"

      - name: Build repository packages
        run: pnpm nx run-many -t build --parallel=5

      - name: Add permissions to linting tools
        run: chmod a=rwx dist/packages/linting-tools/bin/cli.js

      - name: Add permissions to alex config file
        run: chmod a=rwx dist/packages/linting-tools/alex/.alexrc

      - name: Add permissions to alex ignore file
        run: chmod a=rwx dist/packages/linting-tools/alex/.alexignore

      - name: Run Linters
        run: pnpm lint

      #- name: Run Formatters
      #  run: pnpm nx format

      - name: Build repository packages
        run: pnpm nx affected -t build --parallel=5 --base=${{ env.NX_BASE }} --head=${{ env.NX_HEAD }}

      #- name: Run Tests
      #  uses: nick-fields/retry@v2.8.3
      #  with:
      #    command: npx nx affected -t test --parallel=3 --configuration=ci --base=${{ github.event.before }}
      #    timeout_minutes: 10
      #    max_attempts: 3

      #- name: Upload coverage to Codecov
      #  uses: codecov/codecov-action@v3

      - name: Add permissions to git tools
        run: chmod a=rwx dist/packages/git-tools/bin/cli.js

      - name: Release Library Version Updates
        run: pnpm release --base=${{ env.NX_BASE }} --head=${{ env.NX_HEAD }}
        env:
          GITHUB_TOKEN: ${{ env.GITHUB_TOKEN }}
          GH_TOKEN: ${{ env.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ env.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ env.NPM_TOKEN }}
          TAG: ${{ inputs.tag }}
