# Note: this pipelines is for the `storm-ops` repository, it should be used to build and release the Storm Nx-Plugin packages.
name: "CI/CD"

on:
  workflow_dispatch:
    inputs:
      tag:
        description: override release tag
        required: false
  push:
    branches:
      - "main"
      - "next"
      - "alpha"
      - "beta"

env:
  CI: true
  NX_DAEMON: false
  NX_VERBOSE_LOGGING: true
  STORM_BOT: Stormie-Bot
  STORM_REPOSITORY: ${{ github.repositoryUrl }}
  STORM_WORKSPACE_ROOT: ${{ github.workspace }}
  NX_BASE: ${{ github.base_ref }}
  NX_HEAD: ${{ github.head_ref }}
  GITHUB_ACTOR: ${{ github.actor }}
  GITHUB_TOKEN: ${{ github.token }}
  NPM_TOKEN: ${{ secrets.STORM_BOT_NPM_TOKEN }}
  CARGO_REGISTRY_TOKEN: ${{ secrets.STORM_BOT_CARGO_TOKEN }}

jobs:
  ci:
    if: github.repository == 'storm-software/storm-ops' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/next' || github.ref == 'refs/heads/alpha' || github.ref == 'refs/heads/beta')
    name: "CI/CD"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Send Slack notification - Deployment started
        uses: slackapi/slack-github-action@v1.25.0
        with:
          channel-id: "notifications"
          payload: |
            {
              "text": "Storm-Ops Deployment started (In Progress)",
              "attachments": [
                {
                  "pretext": "Storm-Ops Deployment started",
                  "color": "1fb2a6",
                  "fields": [
                    {
                      "title": "Status",
                      "short": true,
                      "value": "In Progress"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.STORM_BOT_SLACK_TOKEN }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.STORM_BOT_GITHUB_TOKEN }}

      - name: Setup workspace
        uses: ./.github/actions/setup
        with:
          packageManager: pnpm
          packageManagerVersion: 8.10.2
          stormBot: ${{ env.STORM_BOT }}

      - name: Build Storm Nx-Plugin packages
        run: pnpm build-plugins
        shell: bash

      - name: Configure git
        run: |
          git config user.name "${{ inputs.stormBot }}"
          git config user.email "${{ inputs.stormBot }}@users.noreply.github.com"
          git config lfs.allowincompletepush true
          npm config set //registry.npmjs.org/:_authToken=$NPM_TOKEN
        shell: bash

      - name: Get appropriate base and head commits for `nx affected` commands
        uses: nrwl/nx-set-shas@v4
        with:
          main-branch-name: "main"

      - name: Set appropriate base and head commits for `nx affected` commands
        run: |
          echo "BASE: ${{ env.NX_BASE }}"
          echo "HEAD: ${{ env.NX_HEAD }}"
        shell: bash

      - name: Run build script
        run: pnpm build-all
        shell: bash

      - name: Run formatters scripts
        run: pnpm nx format
        shell: bash

      - name: Re-run build script
        run: pnpm build-all
        shell: bash

      - name: Add permissions to linting tools
        run: chmod a=rwx dist/packages/linting-tools/bin/lint.js
      - name: Add permissions to alex config file
        run: chmod a=rwx dist/packages/linting-tools/alex/.alexrc
      - name: Add permissions to alex ignore file
        run: chmod a=rwx dist/packages/linting-tools/alex/.alexignore

      - name: Add permissions to linting-tools package.json file
        run: chmod a=rwx packages/linting-tools/package.json
      - name: Add permissions to git-tools package.json file
        run: chmod a=rwx packages/git-tools/package.json
      - name: Add permissions to workspace-tools package.json file
        run: chmod a=rwx packages/workspace-tools/package.json
      - name: Add permissions to create-storm-workspace package.json file
        run: chmod a=rwx packages/create-storm-workspace/package.json

      - name: Add permissions to linting-tools distribution package.json file
        run: chmod a=rwx dist/packages/linting-tools/package.json
      - name: Add permissions to git-tools distribution package.json file
        run: chmod a=rwx dist/packages/git-tools/package.json
      - name: Add permissions to workspace-tools distribution package.json file
        run: chmod a=rwx dist/packages/workspace-tools/package.json
      - name: Add permissions to create-storm-workspace distribution package.json file
        run: chmod a=rwx dist/packages/create-storm-workspace/package.json

      - name: Build repository packages
        run: pnpm nx affected -t build --parallel=5 --base=${{ env.NX_BASE }} --head=${{ env.NX_HEAD }}

      - name: Add permissions to git tools
        run: chmod a=rwx dist/packages/git-tools/bin/git.js

      - name: Release Library Version Updates
        run: pnpm release --base=${{ env.NX_BASE }} --head=${{ env.NX_HEAD }}
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ github.token }}
          GH_TOKEN: ${{ github.token }}
          NPM_TOKEN: ${{ secrets.STORM_BOT_NPM_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.STORM_BOT_CARGO_TOKEN }}
          STORM_BOT: Stormie-Bot
          STORM_WORKSPACE_ROOT: ${{ github.workspace }}
          STORM_REPOSITORY: ${{ github.repositoryUrl }}
          TAG: ${{ inputs.tag }}

  success:
    needs:
      - ci
    if: ${{ success() }}
    name: Send success notification
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack notification - Deployment completed
        uses: slackapi/slack-github-action@v1.25.0
        with:
          channel-id: "notifications"
          update-ts: ${{ steps.ci.outputs.ts }}
          payload: |
            {
              "text": "Storm-Ops Deployment finished (Completed) \n\nStatus: ${{ job.status }} \nOutput: ${{ job.output }} \nLogs: ${{ job.logs }}\nSteps: ${{ job.steps }} \nActions: ${{ job.actions }} \nServices: ${{ job.services }} \nEnvironment: ${{ job.environment}} \nClick here to see the full job details: ${{ github.event.pull_request.html_url || github.event.head_commit.url }}",
              "attachments": [
                {
                  "pretext": "Storm-Ops Deployment finished",
                  "color": "087f5b",
                  "fields": [
                    {
                      "title": "Status",
                      "short": true,
                      "value": "Completed"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.STORM_BOT_SLACK_TOKEN }}

  failure:
    needs:
      - ci
    if: ${{ failure() }}
    name: Send failure notification
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack notification - Deployment completed
        uses: slackapi/slack-github-action@v1.25.0
        with:
          channel-id: "notifications"
          update-ts: ${{ steps.ci.outputs.ts }}
          payload: |
            {
              "text": "Storm-Ops Deployment finished (Failure) \n\nStatus: ${{ job.status }}\nError: ${{ job.conclusion }}\nReason: ${{ job.cancelled }}\nConclusion: ${{ job.conclusion }}\nOutput: ${{ job.output }}\nLogs: ${{ job.logs }} \nSteps: ${{ job.steps }} \nActions: ${{ job.actions }} \nServices: ${{ job.services }} \nEnvironment: ${{ job.environment}} \nClick here to see the full job details: ${{ github.event.pull_request.html_url || github.event.head_commit.url }}",
              "attachments": [
                {
                  "pretext": "Storm-Ops Deployment finished",
                  "color": "990000",
                  "fields": [
                    {
                      "title": "Status",
                      "short": true,
                      "value": "Failure"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.STORM_BOT_SLACK_TOKEN }}
